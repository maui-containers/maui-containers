name: ðŸŽ Build Tart macOS VM Images

on:
  workflow_dispatch:
    inputs:
      dotnet_channel:
        description: '.NET channel to build (9.0 or 10.0)'
        required: true
        type: choice
        options:
          - '9.0'
          - '10.0'
        default: '10.0'
      workload_set_version:
        description: 'Specific workload set version (e.g., 10.0.100-rc.1.24557.12). Leave empty for auto-detect.'
        required: false
        type: string
      image_type:
        description: 'Image type to build'
        required: true
        type: choice
        options:
          - 'maui'
        default: 'maui'
      force_build:
        description: 'Force rebuild even if image exists'
        required: false
        default: false
        type: boolean
      push_to_registry:
        description: 'Push to registry after build'
        required: false
        default: false
        type: boolean
      registry:
        description: 'Docker registry for pushing images (optional)'
        required: false
        type: string

env:
  DOTNET_CHANNEL: ${{ inputs.dotnet_channel || '10.0' }}
  IMAGE_TYPE: ${{ inputs.image_type || 'maui' }}
  WORKLOAD_SET_VERSION: ${{ inputs.workload_set_version }}
  TART_REGISTRY: ghcr.io/maui-containers

jobs:
  build-tart-macos:
    name: ðŸŽ Build Tart VM (.NET ${{ inputs.dotnet_channel || '10.0' }})
    runs-on: self-hosted
    permissions:
      contents: read
      packages: write

    steps:
    - name: ðŸ›’ Checkout
      uses: actions/checkout@v4

    - name: ðŸ”§ Install Prerequisites
      run: |
        echo "Installing Homebrew packages..."
        brew install cirruslabs/cli/tart
        brew install hashicorp/tap/packer
        brew install jq

        echo "Verifying installations..."
        tart --version
        packer --version
        jq --version
        pwsh --version

    - name: ðŸ§¹ Clean Up Space
      run: |
        echo "Checking available disk space..."
        df -h

        echo "Cleaning up existing Tart images..."
        tart list || true

        # Remove CI build image if it exists from previous builds
        echo "Removing maui-macos-ci image if it exists..."
        tart delete maui-macos-ci 2>&1 || echo "  (image not found, skipping)"

        # Remove any existing build artifacts to free up space
        brew cleanup || true

        echo "Disk space after cleanup:"
        df -h

    - name: ðŸ” Login to GitHub Container Registry
      if: github.ref == 'refs/heads/main' || inputs.push_to_registry == true
      run: |
        echo "Unlocking keychain..."
        security unlock-keychain -p ${{ secrets.CI_KEYCHAIN_PASSWORD }} ~/Library/Keychains/login.keychain-db
        echo "Logging in to GitHub via Tart..."
        echo "${{ secrets.GITHUB_TOKEN }}" | tart login ghcr.io --username "${{ github.actor }}" --password-stdin
        echo "Login successful"

    - name: ðŸ”§ Build Tart VM Image
      shell: pwsh
      env:
        # Packer uses this to authenticate GitHub API requests for plugin downloads
        PACKER_GITHUB_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        Write-Host "=== Build Configuration ==="
        Write-Host ".NET Channel: ${{ env.DOTNET_CHANNEL }}"
        Write-Host "Image Type: ${{ env.IMAGE_TYPE }}"
        Write-Host "Workload Set Version: ${{ env.WORKLOAD_SET_VERSION }}"
        Write-Host ""

        $buildArgs = @{
          ImageType         = "${{ env.IMAGE_TYPE }}"
          DotnetChannel     = "${{ env.DOTNET_CHANNEL }}"
          ImageName         = "maui-macos-ci"
          RegistryImageName = "maui-macos"
        }

        # Add workload set version if specified
        if ("${{ env.WORKLOAD_SET_VERSION }}" -ne "") {
          $buildArgs.WorkloadSetVersion = "${{ env.WORKLOAD_SET_VERSION }}"
          Write-Host "Using specific workload set version: ${{ env.WORKLOAD_SET_VERSION }}"
        } else {
          Write-Host "No workload set version specified - will auto-detect latest"
        }

        # Note: -Force is not needed since we delete maui-macos-ci before building

        # Determine if we should push to registry
        $shouldPush = $false
        $registry = ""

        if ("${{ github.ref }}" -eq "refs/heads/main") {
          Write-Host "Building from main branch - will push to GHCR"
          $shouldPush = $true
          $registry = "${{ env.TART_REGISTRY }}"
        } elseif ("${{ inputs.push_to_registry }}" -eq "true") {
          Write-Host "Manual push requested"
          $shouldPush = $true
          if ("${{ inputs.registry }}" -ne "") {
            $registry = "${{ inputs.registry }}"
          } else {
            $registry = "${{ env.TART_REGISTRY }}"
          }
        }

        if ($shouldPush) {
          $buildArgs.Push = $true
          $buildArgs.Registry = $registry
          Write-Host "Will push to registry: $registry"
        } else {
          Write-Host "Build only - not pushing to registry"
        }

        Write-Host ""
        Write-Host "=== Build Parameters ==="
        $buildArgs.GetEnumerator() | ForEach-Object {
          Write-Host "  $($_.Key): $($_.Value)"
        }
        Write-Host ""

        cd tart/macos/scripts
        ./build.ps1 @buildArgs

    - name: ðŸ“Š Verify Build
      shell: pwsh
      run: |
        Write-Host "Listing built Tart images..."
        tart list

        Write-Host ""
        Write-Host "Checking disk space after build..."
        df -h

    - name: ðŸ“¦ Export Build Info
      if: success()
      shell: pwsh
      run: |
        $imageName = if ("${{ env.DOTNET_CHANNEL }}" -eq "9.0") {
          "maui-dev-tahoe-dotnet9.0"
        } else {
          "maui-dev-tahoe-dotnet10.0"
        }

        Write-Host "Build completed successfully!"
        Write-Host "Image name: $imageName"
        Write-Host ""

        if ("${{ github.ref }}" -eq "refs/heads/main" -or "${{ inputs.push_to_registry }}" -eq "true") {
          $registry = if ("${{ inputs.registry }}" -ne "") { "${{ inputs.registry }}" } else { "${{ env.TART_REGISTRY }}" }
          Write-Host "Image published to: $registry/$imageName"
          Write-Host ""
          Write-Host "To pull and run from registry:"
          Write-Host "  tart clone $registry/$imageName $imageName"
          Write-Host "  tart run $imageName"
          Write-Host ""
        } else {
          Write-Host "Image built locally (not pushed to registry)"
          Write-Host ""
        }

        Write-Host "To run the VM locally:"
        Write-Host "  tart run $imageName"
        Write-Host ""
        Write-Host "To run with GitHub Actions runner:"
        Write-Host "  GITHUB_ORG=your-org GITHUB_TOKEN=ghp_xxx tart run $imageName"
        Write-Host ""
        Write-Host "To run with Gitea Actions runner:"
        Write-Host "  GITEA_INSTANCE_URL=https://gitea.example.com GITEA_RUNNER_TOKEN=xxx tart run $imageName"

    - name: ðŸ§¹ Cleanup Local Images
      if: always()
      shell: pwsh
      run: |
        Write-Host "Cleaning up local Tart images to free disk space..."

        Write-Host "Images before cleanup:"
        tart list

        # Remove the CI build image
        Write-Host "Removing local image: maui-macos-ci"
        tart delete maui-macos-ci 2>&1 | Out-Null || Write-Host "  (image not found, skipping)"

        Write-Host ""
        Write-Host "Images after cleanup:"
        tart list

        Write-Host ""
        Write-Host "Disk space after cleanup:"
        df -h

        Write-Host "Cleanup complete"

  build-summary:
    name: ðŸ“‹ Build Summary
    runs-on: ubuntu-latest
    needs: build-tart-macos
    if: always()

    steps:
    - name: ðŸ“‹ Generate Summary
      run: |
        echo "## Tart VM Build Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Configuration" >> $GITHUB_STEP_SUMMARY
        echo "- **.NET Channel:** ${{ env.DOTNET_CHANNEL }}" >> $GITHUB_STEP_SUMMARY
        if [ -n "${{ env.WORKLOAD_SET_VERSION }}" ]; then
          echo "- **Workload Set Version:** ${{ env.WORKLOAD_SET_VERSION }}" >> $GITHUB_STEP_SUMMARY
        else
          echo "- **Workload Set Version:** Auto-detected (latest)" >> $GITHUB_STEP_SUMMARY
        fi
        echo "- **Image Type:** ${{ env.IMAGE_TYPE }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Force Build:** ${{ inputs.force_build }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Push to Registry:** ${{ inputs.push_to_registry }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Build Results" >> $GITHUB_STEP_SUMMARY
        echo "- **macOS Build:** ${{ needs.build-tart-macos.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ "${{ needs.build-tart-macos.result }}" == "success" ]; then
          echo "âœ… Build completed successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Image Details" >> $GITHUB_STEP_SUMMARY
          if [ "${{ env.DOTNET_CHANNEL }}" == "9.0" ]; then
            IMAGE_NAME="maui-dev-tahoe-dotnet9.0"
          else
            IMAGE_NAME="maui-dev-tahoe-dotnet10.0"
          fi
          echo "- **Image Name:** $IMAGE_NAME" >> $GITHUB_STEP_SUMMARY

          # Check if published to registry
          if [ "${{ github.ref }}" == "refs/heads/main" ] || [ "${{ inputs.push_to_registry }}" == "true" ]; then
            if [ -n "${{ inputs.registry }}" ]; then
              REGISTRY="${{ inputs.registry }}"
            else
              REGISTRY="${{ env.TART_REGISTRY }}"
            fi
            echo "- **Published to:** \`$REGISTRY/$IMAGE_NAME\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Available Tags" >> $GITHUB_STEP_SUMMARY
            echo "- \`:latest\` - Latest build" >> $GITHUB_STEP_SUMMARY
            if [ -n "${{ env.WORKLOAD_SET_VERSION }}" ]; then
              echo "- \`:workloads${{ env.WORKLOAD_SET_VERSION }}\` - Specific workload version" >> $GITHUB_STEP_SUMMARY
            else
              echo "- \`:workloads{version}\` - Specific workload version (auto-detected during build)" >> $GITHUB_STEP_SUMMARY
            fi
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Pull and Run" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
            echo "# Pull latest" >> $GITHUB_STEP_SUMMARY
            echo "tart pull $REGISTRY/$IMAGE_NAME:latest" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "# Run the VM" >> $GITHUB_STEP_SUMMARY
            echo "tart run $REGISTRY/$IMAGE_NAME:latest" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Status:** Built locally (not published)" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Base:** macOS Tahoe 16 (Sequoia)" >> $GITHUB_STEP_SUMMARY
          echo "- **Xcode:** 26 (base) + 16.4 (additional)" >> $GITHUB_STEP_SUMMARY
          echo "- **.NET:** ${{ env.DOTNET_CHANNEL }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Capabilities" >> $GITHUB_STEP_SUMMARY
          echo "- iOS/tvOS/macOS builds" >> $GITHUB_STEP_SUMMARY
          echo "- Android builds" >> $GITHUB_STEP_SUMMARY
          echo "- .NET MAUI development" >> $GITHUB_STEP_SUMMARY
          echo "- UI testing with Appium" >> $GITHUB_STEP_SUMMARY
          echo "- GitHub Actions runner (auto-register)" >> $GITHUB_STEP_SUMMARY
          echo "- Gitea Actions runner (auto-register)" >> $GITHUB_STEP_SUMMARY
          echo "- Multiple Xcode versions" >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ Build failed. Please check the job logs for details." >> $GITHUB_STEP_SUMMARY
        fi
