name: üêã Build Docker Images (Linux)

on:
  workflow_dispatch:
    inputs:
      workload_set_version:
        description: 'Specific workload set version to use'
        required: false
        type: string
      dotnet_versions:
        description: 'JSON array of .NET versions to build (e.g., ["9.0", "10.0"])'
        required: false
        type: string
        default: '["9.0", "10.0"]'
  repository_dispatch:
    types: [trigger-docker-linux-build]

permissions:
  contents: read
  packages: write

jobs:
  build-linux:
    name: üêß Build Linux (.NET ${{ matrix.DOTNET_VERSION }})
    runs-on: ubuntu-latest

    strategy:
      matrix:
        DOTNET_VERSION: ${{ fromJson(inputs.dotnet_versions || '["9.0", "10.0"]') }}

    steps:
    - name: üõí Checkout
      uses: actions/checkout@v4

    - name: üìã Set Variables
      id: vars
      run: |
        # Determine workload set version from either workflow_dispatch input or repository_dispatch payload
        if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
          WORKLOAD_SET_VERSION="${{ github.event.client_payload.workload_set_version }}"
        else
          WORKLOAD_SET_VERSION="${{ inputs.workload_set_version }}"
        fi
        echo "workload_set_version=$WORKLOAD_SET_VERSION" >> $GITHUB_OUTPUT
        echo "Using workload set version: $WORKLOAD_SET_VERSION"

        # Get short Git SHA for unique build tagging
        BUILD_SHA=$(git rev-parse --short=8 HEAD)
        echo "build_sha=$BUILD_SHA" >> $GITHUB_OUTPUT
        echo "Build SHA: $BUILD_SHA"

    - name: üêã Login to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: üî® Build Docker Image
      shell: pwsh
      run: |
        # Build arguments
        $buildArgs = @{
          DotNetVersion     = "${{ matrix.DOTNET_VERSION }}"
          Version           = "${{ github.run_id }}"
          DockerPlatform    = "linux/amd64"
          BuildSha          = "${{ steps.vars.outputs.build_sha }}"
          Load              = $true
        }
        if ("${{ github.ref }}" -eq "refs/heads/main") {
          $buildArgs.Push = $true
        }
        # Add workload set version if specified
        if ("${{ steps.vars.outputs.workload_set_version }}" -ne "") {
          $buildArgs.WorkloadSetVersion = "${{ steps.vars.outputs.workload_set_version }}"
        }

        ./docker/build.ps1 @buildArgs
