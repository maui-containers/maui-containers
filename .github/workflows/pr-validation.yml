name: üîç PR Validation - Build Docker Images

on:
  pull_request:
    branches: [ main ]
    paths:
      - 'docker/**'
      - 'tart/**'
      - 'common-functions.ps1'
      - '.github/workflows/**'
  workflow_dispatch:
    inputs:
      dotnet_versions:
        description: 'JSON array of .NET versions to test (e.g., ["9.0", "10.0"])'
        required: false
        type: string
        default: '["9.0", "10.0"]'
      test_subset:
        description: 'Test subset: all, base-only, or single-platform'
        required: false
        type: choice
        default: 'all'
        options:
          - 'all'
          - 'base-only' 
          - 'single-platform'

env:
  # Use test repository names to avoid conflicts
  DOCKER_REPOSITORY_BASE: pr-test/maui-build
  DOCKER_REPOSITORY_TEST: pr-test/maui-testing

jobs:
  # Step 1: Validate workload discovery and build preparation
  validate-workloads:
    name: üîç Validate Workload Discovery
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.determine-matrix.outputs.matrix }}
      workload-summary: ${{ steps.get-workload-info.outputs.workload-summary }}
    
    steps:
    - name: üõí Checkout
      uses: actions/checkout@v4

    - name: üîç Test Workload Discovery
      id: get-workload-info
      shell: pwsh
      run: |
        # Import common functions
        . ./common-functions.ps1
        
        # Define .NET versions to check
        $dotnetVersionsInput = '${{ inputs.dotnet_versions }}'
        $dotnetVersions = if ($dotnetVersionsInput -ne "") {
          $dotnetVersionsInput | ConvertFrom-Json
        } else {
          @("9.0", "10.0")
        }
        
        Write-Host "## Workload Discovery Test Results" >> $env:GITHUB_STEP_SUMMARY
        Write-Host "" >> $env:GITHUB_STEP_SUMMARY
        
        $workloadSummary = @{}
        $allSuccessful = $true
        
        foreach ($dotnetVersion in $dotnetVersions) {
          Write-Host "Testing workload discovery for .NET $dotnetVersion"
          
          try {
            $workloadInfo = Get-WorkloadInfo -DotnetVersion $dotnetVersion -IncludeAndroid -DockerPlatform "linux/amd64"
            
            if ($workloadInfo -and $workloadInfo.Workloads["Microsoft.NET.Sdk.Android"] -and $workloadInfo.Workloads["Microsoft.NET.Sdk.Android"].Details) {
              $androidInfo = $workloadInfo.Workloads["Microsoft.NET.Sdk.Android"]
              $workloadSummary[$dotnetVersion] = @{
                Success = $true
                WorkloadSetVersion = $workloadInfo.WorkloadSetVersion
                AndroidVersion = $androidInfo.Version
                ApiLevel = $androidInfo.Details.ApiLevel
                JdkVersion = $androidInfo.Details.JdkMajorVersion
              }
              
              Write-Host "### ‚úÖ .NET $dotnetVersion" >> $env:GITHUB_STEP_SUMMARY
              Write-Host "- **Workload Set:** $($workloadInfo.WorkloadSetVersion)" >> $env:GITHUB_STEP_SUMMARY
              Write-Host "- **Android API Level:** $($androidInfo.Details.ApiLevel)" >> $env:GITHUB_STEP_SUMMARY
              Write-Host "- **JDK Version:** $($androidInfo.Details.JdkMajorVersion)" >> $env:GITHUB_STEP_SUMMARY
              Write-Host "" >> $env:GITHUB_STEP_SUMMARY
            } else {
              throw "Failed to get Android workload information"
            }
          }
          catch {
            $allSuccessful = $false
            $workloadSummary[$dotnetVersion] = @{
              Success = $false
              Error = $_.Exception.Message
            }
            
            Write-Host "### ‚ùå .NET $dotnetVersion" >> $env:GITHUB_STEP_SUMMARY
            Write-Host "- **Error:** $($_.Exception.Message)" >> $env:GITHUB_STEP_SUMMARY
            Write-Host "" >> $env:GITHUB_STEP_SUMMARY
          }
        }
        
        if (-not $allSuccessful) {
          Write-Error "Workload discovery failed for one or more .NET versions"
          exit 1
        }
        
        # Output the workload summary as JSON
        $workloadSummaryJson = $workloadSummary | ConvertTo-Json -Compress -Depth 3
        echo "workload-summary=$workloadSummaryJson" >> $env:GITHUB_OUTPUT

    - name: üéØ Determine Build Matrix
      id: determine-matrix
      shell: pwsh
      run: |
        # Parse workload summary
        $workloadSummary = '${{ steps.get-workload-info.outputs.workload-summary }}' | ConvertFrom-Json
        
        # Define .NET versions to use
        $dotnetVersionsInput = '${{ inputs.dotnet_versions }}'
        $dotnetVersions = if ($dotnetVersionsInput -ne "") {
          $dotnetVersionsInput | ConvertFrom-Json
        } else {
          @("9.0", "10.0")
        }
        
        # Determine subset based on input
        $testSubset = '${{ inputs.test_subset }}'
        if ($testSubset -eq "") { $testSubset = "base-only" }
        
        Write-Host "Test subset: $testSubset"
        
        function New-MatrixEntry {
          param(
            [string]$DotnetVersion,
            [string]$Platform,
            [string]$RunnerOs,
            [string]$BuildRunner = 'false',
            [string]$BuildTest = 'false',
            [string]$AndroidApiLevel = ''
          )

          $entry = @{
            dotnet_version = $DotnetVersion
            platform       = $Platform
            runner_os      = $RunnerOs
            build_runner   = $BuildRunner
            build_test     = $BuildTest
          }

          if ($AndroidApiLevel -ne '') {
            $entry.android_api_level = $AndroidApiLevel
          }

          return $entry
        }

        # Create matrix based on test subset
        $matrix = @()

        if ($testSubset -eq "single-platform") {
          $matrix += New-MatrixEntry -DotnetVersion $dotnetVersions[0] -Platform "linux" -RunnerOs "ubuntu-latest"
        }
        elseif ($testSubset -eq "base-only") {
          foreach ($dotnetVersion in $dotnetVersions) {
            $matrix += New-MatrixEntry -DotnetVersion $dotnetVersion -Platform "linux" -RunnerOs "ubuntu-latest"
            $matrix += New-MatrixEntry -DotnetVersion $dotnetVersion -Platform "windows" -RunnerOs "windows-latest"
          }
        }
        else {
          foreach ($dotnetVersion in $dotnetVersions) {
            $matrix += New-MatrixEntry -DotnetVersion $dotnetVersion -Platform "linux" -RunnerOs "ubuntu-latest" -BuildTest 'true' -AndroidApiLevel '35'
            $matrix += New-MatrixEntry -DotnetVersion $dotnetVersion -Platform "windows" -RunnerOs "windows-latest"
          }
        }
        
        # Convert to GitHub Actions matrix format
        $matrixJson = @{ include = $matrix } | ConvertTo-Json -Compress -Depth 3
        Write-Host "Matrix: $matrixJson"
        echo "matrix=$matrixJson" >> $env:GITHUB_OUTPUT

  # Step 2: Determine what changed
  detect-changes:
    name: üîç Detect Changes
    runs-on: ubuntu-latest
    outputs:
      docker-linux: ${{ steps.filter.outputs.docker-linux }}
      docker-windows: ${{ steps.filter.outputs.docker-windows }}
      tart-macos: ${{ steps.filter.outputs.tart-macos }}
      common: ${{ steps.filter.outputs.common }}
    steps:
    - name: üõí Checkout
      uses: actions/checkout@v4

    - name: üîç Check changed files
      uses: dorny/paths-filter@v3
      id: filter
      with:
        filters: |
          docker-linux:
            - 'docker/linux/**'
            - 'docker/build.ps1'
          docker-windows:
            - 'docker/windows/**'
            - 'docker/build.ps1'
          tart-macos:
            - 'tart/**'
          common:
            - 'common-functions.ps1'
            - '.github/workflows/**'

  # Step 3: Build Docker Images (no push)
  build-images:
    name: üî® Build Images (${{ matrix.platform }}, .NET ${{ matrix.dotnet_version }})
    runs-on: ${{ matrix.runner_os }}
    needs: [validate-workloads, detect-changes]
    if: |
      needs.validate-workloads.result == 'success' &&
      (needs.detect-changes.outputs.common == 'true' ||
       needs.detect-changes.outputs.docker-linux == 'true' ||
       needs.detect-changes.outputs.docker-windows == 'true')
    strategy:
      matrix: ${{ fromJson(needs.validate-workloads.outputs.matrix) }}
      fail-fast: false
      max-parallel: 4  # Limit parallel builds to avoid resource issues
    
    steps:
    - name: üõí Checkout
      uses: actions/checkout@v4

    - name: üíæ Setup Docker Buildx
      if: matrix.platform == 'linux'
      uses: docker/setup-buildx-action@v3
      with:
        driver: docker

    - name: üî® Build Docker image
      shell: pwsh
      run: |
        Write-Host "Building Docker image for .NET ${{ matrix.dotnet_version }} on ${{ matrix.platform }}"
        $dockerPlatform = "${{ matrix.platform }}/amd64"
        $buildArgs = @{
          DotnetVersion    = "${{ matrix.dotnet_version }}"
          DockerRepository = "${{ env.DOCKER_REPOSITORY_BASE }}"
          DockerPlatform   = $dockerPlatform
          Version          = "pr-test"
          Push             = $false
          Load             = $true
        }
        ./docker/build.ps1 @buildArgs

    - name: üîç Validate Docker image
      shell: pwsh
      run: |
        $imageName = "${{ env.DOCKER_REPOSITORY_BASE }}:dotnet${{ matrix.dotnet_version }}-pr-test"
        Write-Host "Validating image: $imageName"
        $imageExists = docker images --format "{{.Repository}}:{{.Tag}}" | Select-String -Pattern "$imageName"
        if ($imageExists) {
          Write-Host "‚úÖ Docker image built successfully: $imageName"
          $imageInfo = docker images --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}\t{{.CreatedAt}}" --filter "reference=$imageName"
          Write-Host $imageInfo
        } else {
          Write-Error "‚ùå Base image not found: $imageName"
          docker images
          exit 1
        }

    - name: üß™ Basic image test
      shell: pwsh
      run: |
        # Construct image name
        $imageName = "${{ env.DOCKER_REPOSITORY_BASE }}:dotnet${{ matrix.dotnet_version }}-pr-test"

        Write-Host "Testing basic functionality of: $imageName"
        
        if ("${{ matrix.platform }}" -eq "linux") {
          # Test dotnet command
          $dotnetVersion = docker run --rm $imageName dotnet --version
          Write-Host "‚úÖ .NET Version: $dotnetVersion"
          
          # Test MAUI workload is installed
          $workloads = docker run --rm $imageName dotnet workload list
          if ($workloads -match "maui") {
            Write-Host "‚úÖ MAUI workload is installed"
          } else {
            Write-Warning "‚ö†Ô∏è MAUI workload may not be installed"
          }
          
          # Test PowerShell
          $pwshVersion = docker run --rm $imageName pwsh -c '$PSVersionTable.PSVersion'
          Write-Host "‚úÖ PowerShell Version: $pwshVersion"
          
          # Test Android SDK tools are available
          $androidHome = docker run --rm $imageName bash -c 'echo $ANDROID_HOME'
          Write-Host "‚úÖ Android Home: $androidHome"
          
          # Test key Android tools
          $androidSdkTools = docker run --rm $imageName bash -c 'ls $ANDROID_HOME/cmdline-tools/*/bin/sdkmanager 2>/dev/null | head -1'
          if ($androidSdkTools) {
            Write-Host "‚úÖ Android SDK Manager found"
          } else {
            Write-Warning "‚ö†Ô∏è Android SDK Manager not found"
          }
          
          # Test Java installation
          $javaVersion = docker run --rm $imageName bash -c 'java -version 2>&1 | head -1'
          Write-Host "‚úÖ Java Version: $javaVersion"
        }
        elseif ("${{ matrix.platform }}" -eq "windows") {
          # Test dotnet command (Windows)
          $dotnetVersion = docker run --rm $imageName powershell -c "dotnet --version"
          Write-Host "‚úÖ .NET Version: $dotnetVersion"
          
          # Test MAUI workload is installed (Windows)
          $workloads = docker run --rm $imageName powershell -c "dotnet workload list"
          if ($workloads -match "maui") {
            Write-Host "‚úÖ MAUI workload is installed"
          } else {
            Write-Warning "‚ö†Ô∏è MAUI workload may not be installed"
          }
          
          # Test Android SDK tools are available (Windows)
          $androidHome = docker run --rm $imageName powershell -c 'echo $env:ANDROID_HOME'
          Write-Host "‚úÖ Android Home: $androidHome"
          
          # Test Java installation (Windows)
          $javaCheck = docker run --rm $imageName powershell -c 'if (Get-Command java -ErrorAction SilentlyContinue) { "Java is available" } else { "Java not found" }'
          if ($javaCheck -match "available") {
            Write-Host "‚úÖ Java is installed and available"
            # Get version info - java -version outputs to stderr and returns exit code 1, which is normal
            $javaVersionOutput = docker run --rm $imageName powershell -c 'java -version 2>&1; if ($LASTEXITCODE -eq 1 -or $LASTEXITCODE -eq 0) { exit 0 }'
            if ($javaVersionOutput) {
              $versionLine = $javaVersionOutput | Select-String "openjdk|java" | Select-Object -First 1
              if ($versionLine) {
                Write-Host "Java Version Info: $versionLine"
              }
            }
          } else {
            Write-Error "‚ùå Java installation test failed: $javaCheck"
            exit 1
          }
        }

    - name: üß™ Test runner functionality
      shell: pwsh
      run: |
        # Construct image name
        $imageName = "${{ env.DOCKER_REPOSITORY_BASE }}:dotnet${{ matrix.dotnet_version }}-pr-test"

        Write-Host "Testing runner functionality: $imageName"

        if ("${{ matrix.platform }}" -eq "linux") {
          # Test that GitHub Actions runner files are present
          $githubRunnerScript = docker run --rm $imageName bash -c 'ls /home/mauiusr/actions-runner/run.sh 2>/dev/null && echo "found" || echo "not found"'
          if ($githubRunnerScript -eq "found") {
            Write-Host "‚úÖ GitHub Actions runner found"
          } else {
            Write-Error "‚ùå GitHub Actions runner script not found"
            exit 1
          }

          # Test that Gitea runner files are present
          $giteaRunnerBinary = docker run --rm $imageName bash -c 'ls /home/mauiusr/gitea-runner/act_runner 2>/dev/null && echo "found" || echo "not found"'
          if ($giteaRunnerBinary -eq "found") {
            Write-Host "‚úÖ Gitea Actions runner found"
          } else {
            Write-Error "‚ùå Gitea Actions runner binary not found"
            exit 1
          }
        }
        elseif ("${{ matrix.platform }}" -eq "windows") {
          # Test that GitHub Actions runner files are present (Windows)
          $githubRunnerScript = docker run --rm $imageName powershell -c "if (Test-Path 'C:\actions-runner\run.cmd') { Write-Output 'found' } else { Write-Output 'not found' }"
          if ($githubRunnerScript -match "found") {
            Write-Host "‚úÖ GitHub Actions runner found"
          } else {
            Write-Error "‚ùå GitHub Actions runner script not found"
            exit 1
          }

          # Test that Gitea runner files are present (Windows)
          $giteaRunnerBinary = docker run --rm $imageName powershell -c "if (Test-Path 'C:\gitea-runner\act_runner.exe') { Write-Output 'found' } else { Write-Output 'not found' }"
          if ($giteaRunnerBinary -match "found") {
            Write-Host "‚úÖ Gitea Actions runner found"
          } else {
            Write-Error "‚ùå Gitea Actions runner binary not found"
            exit 1
          }
        }

    - name: üî® Build test image
      if: matrix.build_test == 'true'
      shell: pwsh
      run: |
        Write-Host "Building test image for .NET ${{ matrix.dotnet_version }} on ${{ matrix.platform }}"
        $dockerPlatform = "${{ matrix.platform }}/amd64"
        $buildArgs = @{
          DotnetVersion        = "${{ matrix.dotnet_version }}"
          DockerRepository     = "${{ env.DOCKER_REPOSITORY_TEST }}"
          DockerPlatform       = $dockerPlatform
          AndroidSdkApiLevel   = "${{ matrix.android_api_level }}"
          Version              = "pr-test"
          Push                 = $false
          Load                 = $true
        }
        if ("${{ matrix.platform }}" -eq "linux") {
          $buildArgs.UseBuildx = $false
        }
        ./docker/test/build.ps1 @buildArgs

    - name: üîç Validate test image
      if: matrix.build_test == 'true'
      shell: pwsh
      run: |
        $imageName = "${{ env.DOCKER_REPOSITORY_TEST }}:android${{ matrix.android_api_level }}-dotnet${{ matrix.dotnet_version }}-pr-test"
        Write-Host "Validating image: $imageName"
        $imageExists = docker images --format "{{.Repository}}:{{.Tag}}" | Select-String -Pattern "$imageName"
        if ($imageExists) {
          Write-Host "‚úÖ Test image built successfully: $imageName"
        } else {
          Write-Error "‚ùå Test image not found: $imageName"
          docker images
          exit 1
        }

    - name: üß™ Test image test
      if: matrix.build_test == 'true'
      shell: pwsh
      run: |
        # Construct image name
        $imageName = "${{ env.DOCKER_REPOSITORY_TEST }}:android${{ matrix.android_api_level }}-dotnet${{ matrix.dotnet_version }}-pr-test"

        Write-Host "Testing Appium/Emulator functionality of: $imageName"
        
        # Test that Appium is installed
        $appiumVersion = docker run --rm $imageName bash -c 'appium --version 2>/dev/null || echo "not found"'
        if ($appiumVersion -ne "not found") {
          Write-Host "‚úÖ Appium Version: $appiumVersion"
        } else {
          Write-Warning "‚ö†Ô∏è Appium not found"
        }
        
        # Test that Android Emulator is available
        $emulatorPath = docker run --rm $imageName bash -c 'which emulator 2>/dev/null || echo "not found"'
        if ($emulatorPath -ne "not found") {
          Write-Host "‚úÖ Android Emulator found at: $emulatorPath"
        } else {
          Write-Warning "‚ö†Ô∏è Android Emulator not found"
        }
        
        # Test that the correct Android API level system image is installed
        $systemImages = docker run --rm $imageName bash -c 'ls $ANDROID_HOME/system-images/android-${{ matrix.android_api_level }}/ 2>/dev/null | head -5 || echo "not found"'
        if ($systemImages -ne "not found") {
          Write-Host "‚úÖ Android ${{ matrix.android_api_level }} system images found"
        } else {
          Write-Warning "‚ö†Ô∏è Android ${{ matrix.android_api_level }} system images not found"
        }

  # Step 4: Build Tart VM Images (macOS only)
  build-tart-images:
    name: üçé Build Tart VM (.NET ${{ matrix.dotnet_version }})
    runs-on: self-hosted
    needs: [validate-workloads, detect-changes]
    if: |
      needs.validate-workloads.result == 'success' &&
      (needs.detect-changes.outputs.common == 'true' ||
       needs.detect-changes.outputs.tart-macos == 'true')
    strategy:
      matrix:
        dotnet_version: ["9.0", "10.0"]
      fail-fast: false

    steps:
    - name: üõí Checkout
      uses: actions/checkout@v4

    - name: üîß Install Prerequisites
      run: |
        echo "Verifying Tart and Packer installation..."
        if ! command -v tart &> /dev/null; then
          echo "Installing Tart..."
          brew install cirruslabs/cli/tart
        fi

        if ! command -v packer &> /dev/null; then
          echo "Installing Packer..."
          brew install hashicorp/tap/packer
        fi

        if ! command -v jq &> /dev/null; then
          echo "Installing jq..."
          brew install jq
        fi

        echo "Verifying installations..."
        tart --version
        packer --version
        jq --version
        pwsh --version

    - name: üßπ Clean Up Old PR Test Images
      run: |
        echo "Cleaning up old PR test images..."
        tart list || true

        # Remove PR test image if it exists
        echo "Removing maui-macos-pr-test-dotnet${{ matrix.dotnet_version }} image if it exists..."
        tart delete maui-macos-pr-test-dotnet${{ matrix.dotnet_version }} 2>&1 || echo "  (image not found, skipping)"

    - name: üîß Build Tart VM Image
      shell: pwsh
      env:
        PACKER_GITHUB_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        Write-Host "=== PR Validation - Tart VM Build ==="
        Write-Host ".NET Channel: ${{ matrix.dotnet_version }}"
        Write-Host ""

        $buildArgs = @{
          ImageType         = "maui"
          DotnetChannel     = "${{ matrix.dotnet_version }}"
          ImageName         = "maui-macos-pr-test-dotnet${{ matrix.dotnet_version }}"
        }

        Write-Host "Building Tart VM image (no push)..."
        Write-Host ""

        cd tart/macos/scripts
        ./build.ps1 @buildArgs

    - name: üîç Validate Tart VM Image
      shell: pwsh
      run: |
        $imageName = "maui-macos-pr-test-dotnet${{ matrix.dotnet_version }}"
        Write-Host "Validating Tart VM image: $imageName"

        $images = tart list
        Write-Host "Available images:"
        Write-Host $images

        if ($images -match [regex]::Escape($imageName)) {
          Write-Host "‚úÖ Tart VM image built successfully: $imageName"
        } else {
          Write-Error "‚ùå Tart VM image not found: $imageName"
          exit 1
        }

    - name: üßπ Cleanup PR Test Images
      if: always()
      shell: pwsh
      run: |
        Write-Host "Cleaning up PR test Tart images..."

        $imageName = "maui-macos-pr-test-dotnet${{ matrix.dotnet_version }}"
        Write-Host "Removing PR test image: $imageName"
        tart delete $imageName 2>&1 | Out-Null || Write-Host "  (image not found, skipping)"

        Write-Host "Cleanup complete"

  # Step 5: Summary and cleanup
  pr-validation-summary:
    name: üìã PR Validation Summary
    runs-on: ubuntu-latest
    needs: [validate-workloads, detect-changes, build-images, build-tart-images]
    if: always()
    
    steps:
    - name: üìã Generate PR Summary
      run: |
        echo "## üîç PR Validation Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # Show what changed
        echo "### üìù Changes Detected" >> $GITHUB_STEP_SUMMARY
        if [ "${{ needs.detect-changes.outputs.docker-linux }}" == "true" ]; then
          echo "- üêß Docker Linux files" >> $GITHUB_STEP_SUMMARY
        fi
        if [ "${{ needs.detect-changes.outputs.docker-windows }}" == "true" ]; then
          echo "- ü™ü Docker Windows files" >> $GITHUB_STEP_SUMMARY
        fi
        if [ "${{ needs.detect-changes.outputs.tart-macos }}" == "true" ]; then
          echo "- üçé Tart macOS files" >> $GITHUB_STEP_SUMMARY
        fi
        if [ "${{ needs.detect-changes.outputs.common }}" == "true" ]; then
          echo "- üîß Common/workflow files (tests all platforms)" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY

        # Workload validation results
        echo "### Workload Discovery" >> $GITHUB_STEP_SUMMARY
        if [ "${{ needs.validate-workloads.result }}" == "success" ]; then
          echo "‚úÖ **Workload discovery passed** - All .NET versions successfully resolved workload sets" >> $GITHUB_STEP_SUMMARY
        else
          echo "‚ùå **Workload discovery failed** - Check workload discovery step for details" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Docker build results
        echo "### Docker Image Builds" >> $GITHUB_STEP_SUMMARY
        if [ "${{ needs.detect-changes.outputs.docker-linux }}" != "true" ] && [ "${{ needs.detect-changes.outputs.docker-windows }}" != "true" ] && [ "${{ needs.detect-changes.outputs.common }}" != "true" ]; then
          echo "‚è≠Ô∏è **Docker builds skipped** - No Docker-related files changed" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ needs.build-images.result }}" == "success" ]; then
          echo "‚úÖ **All Docker image builds successful** - Images built and validated locally" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ needs.build-images.result }}" == "failure" ]; then
          echo "‚ùå **Some Docker image builds failed** - Check individual build jobs for details" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ needs.build-images.result }}" == "cancelled" ]; then
          echo "‚ö†Ô∏è **Docker image builds cancelled** - Builds were cancelled" >> $GITHUB_STEP_SUMMARY
        else
          echo "‚è≠Ô∏è **Docker image builds skipped** - Skipped due to workload validation failure" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY

        # Tart build results
        echo "### Tart VM Image Builds" >> $GITHUB_STEP_SUMMARY
        if [ "${{ needs.detect-changes.outputs.tart-macos }}" != "true" ] && [ "${{ needs.detect-changes.outputs.common }}" != "true" ]; then
          echo "‚è≠Ô∏è **Tart builds skipped** - No Tart-related files changed" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ needs.build-tart-images.result }}" == "success" ]; then
          echo "‚úÖ **All Tart VM image builds successful** - VMs built and validated locally" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ needs.build-tart-images.result }}" == "failure" ]; then
          echo "‚ùå **Some Tart VM image builds failed** - Check individual build jobs for details" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ needs.build-tart-images.result }}" == "cancelled" ]; then
          echo "‚ö†Ô∏è **Tart VM image builds cancelled** - Builds were cancelled" >> $GITHUB_STEP_SUMMARY
        else
          echo "‚è≠Ô∏è **Tart VM image builds skipped** - Skipped due to workload validation failure" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY

        # Overall status
        echo "### Overall Status" >> $GITHUB_STEP_SUMMARY

        # Check if workloads failed
        if [ "${{ needs.validate-workloads.result }}" != "success" ]; then
          echo "üö´ **PR validation failed** - Workload discovery failed" >> $GITHUB_STEP_SUMMARY
        # Check if any required builds failed
        elif [ "${{ needs.build-images.result }}" == "failure" ] || [ "${{ needs.build-tart-images.result }}" == "failure" ]; then
          echo "üö´ **PR validation failed** - Some builds failed" >> $GITHUB_STEP_SUMMARY
        else
          echo "üéâ **PR validation passed!** This PR is ready for review." >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Note:** Only changed components were tested. No images were pushed to registries." >> $GITHUB_STEP_SUMMARY

    - name: üîç Set Job Status
      run: |
        # Fail if workloads failed
        if [ "${{ needs.validate-workloads.result }}" != "success" ]; then
          echo "PR validation failed: workload discovery failed"
          exit 1
        fi

        # Fail if Docker builds were run and failed
        if [ "${{ needs.build-images.result }}" == "failure" ]; then
          echo "PR validation failed: Docker builds failed"
          exit 1
        fi

        # Fail if Tart builds were run and failed
        if [ "${{ needs.build-tart-images.result }}" == "failure" ]; then
          echo "PR validation failed: Tart builds failed"
          exit 1
        fi

        echo "PR validation passed"
