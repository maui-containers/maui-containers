name: ğŸ” PR Validation - Build Docker Images

on:
  pull_request:
    branches: [ main ]
    paths:
      - 'docker/**'
      - 'tart/**'
      - 'common-functions.ps1'
      - '.github/workflows/**'
  workflow_dispatch:
    inputs:
      dotnet_versions:
        description: 'JSON array of .NET versions to test (e.g., ["9.0", "10.0"])'
        required: false
        type: string
        default: '["9.0", "10.0"]'
      test_subset:
        description: 'Test subset: all, base-only, or single-platform'
        required: false
        type: choice
        default: 'all'
        options:
          - 'all'
          - 'base-only' 
          - 'single-platform'

env:
  # Use test repository names to avoid conflicts
  DOCKER_REPOSITORY_BASE: pr-test/maui-build
  DOCKER_REPOSITORY_TEST: pr-test/maui-testing

jobs:
  # Step 1: Validate workload discovery and build preparation
  validate-workloads:
    name: ğŸ” Validate Workload Discovery
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.determine-matrix.outputs.matrix }}
      workload-summary: ${{ steps.get-workload-info.outputs.workload-summary }}
    
    steps:
    - name: ğŸ›’ Checkout
      uses: actions/checkout@v4

    - name: ğŸ” Test Workload Discovery
      id: get-workload-info
      shell: pwsh
      run: |
        # Import common functions
        . ./common-functions.ps1
        
        # Define .NET versions to check
        $dotnetVersionsInput = '${{ inputs.dotnet_versions }}'
        $dotnetVersions = if ($dotnetVersionsInput -ne "") {
          $dotnetVersionsInput | ConvertFrom-Json
        } else {
          @("9.0", "10.0")
        }
        
        Write-Host "## Workload Discovery Test Results" >> $env:GITHUB_STEP_SUMMARY
        Write-Host "" >> $env:GITHUB_STEP_SUMMARY
        
        $workloadSummary = @{}
        $allSuccessful = $true
        
        foreach ($dotnetVersion in $dotnetVersions) {
          Write-Host "Testing workload discovery for .NET $dotnetVersion"
          
          try {
            $workloadInfo = Get-WorkloadInfo -DotnetVersion $dotnetVersion -IncludeAndroid -DockerPlatform "linux/amd64"
            
            if ($workloadInfo -and $workloadInfo.Workloads["Microsoft.NET.Sdk.Android"] -and $workloadInfo.Workloads["Microsoft.NET.Sdk.Android"].Details) {
              $androidInfo = $workloadInfo.Workloads["Microsoft.NET.Sdk.Android"]
              $workloadSummary[$dotnetVersion] = @{
                Success = $true
                WorkloadSetVersion = $workloadInfo.WorkloadSetVersion
                AndroidVersion = $androidInfo.Version
                ApiLevel = $androidInfo.Details.ApiLevel
                JdkVersion = $androidInfo.Details.JdkMajorVersion
              }
              
              Write-Host "### âœ… .NET $dotnetVersion" >> $env:GITHUB_STEP_SUMMARY
              Write-Host "- **Workload Set:** $($workloadInfo.WorkloadSetVersion)" >> $env:GITHUB_STEP_SUMMARY
              Write-Host "- **Android API Level:** $($androidInfo.Details.ApiLevel)" >> $env:GITHUB_STEP_SUMMARY
              Write-Host "- **JDK Version:** $($androidInfo.Details.JdkMajorVersion)" >> $env:GITHUB_STEP_SUMMARY
              Write-Host "" >> $env:GITHUB_STEP_SUMMARY
            } else {
              throw "Failed to get Android workload information"
            }
          }
          catch {
            $allSuccessful = $false
            $workloadSummary[$dotnetVersion] = @{
              Success = $false
              Error = $_.Exception.Message
            }
            
            Write-Host "### âŒ .NET $dotnetVersion" >> $env:GITHUB_STEP_SUMMARY
            Write-Host "- **Error:** $($_.Exception.Message)" >> $env:GITHUB_STEP_SUMMARY
            Write-Host "" >> $env:GITHUB_STEP_SUMMARY
          }
        }
        
        if (-not $allSuccessful) {
          Write-Error "Workload discovery failed for one or more .NET versions"
          exit 1
        }
        
        # Output the workload summary as JSON
        $workloadSummaryJson = $workloadSummary | ConvertTo-Json -Compress -Depth 3
        echo "workload-summary=$workloadSummaryJson" >> $env:GITHUB_OUTPUT

    - name: ğŸ¯ Determine Build Matrix
      id: determine-matrix
      shell: pwsh
      run: |
        # Parse workload summary
        $workloadSummary = '${{ steps.get-workload-info.outputs.workload-summary }}' | ConvertFrom-Json
        
        # Define .NET versions to use
        $dotnetVersionsInput = '${{ inputs.dotnet_versions }}'
        $dotnetVersions = if ($dotnetVersionsInput -ne "") {
          $dotnetVersionsInput | ConvertFrom-Json
        } else {
          @("9.0", "10.0")
        }
        
        # Determine subset based on input
        $testSubset = '${{ inputs.test_subset }}'
        if ($testSubset -eq "") { $testSubset = "base-only" }
        
        Write-Host "Test subset: $testSubset"
        
        function New-MatrixEntry {
          param(
            [string]$DotnetVersion,
            [string]$Platform,
            [string]$RunnerOs,
            [string]$BuildRunner = 'false',
            [string]$BuildTest = 'false',
            [string]$AndroidApiLevel = ''
          )

          $entry = @{
            dotnet_version = $DotnetVersion
            platform       = $Platform
            runner_os      = $RunnerOs
            build_runner   = $BuildRunner
            build_test     = $BuildTest
          }

          if ($AndroidApiLevel -ne '') {
            $entry.android_api_level = $AndroidApiLevel
          }

          return $entry
        }

        # Create matrix based on test subset
        $matrix = @()

        if ($testSubset -eq "single-platform") {
          $matrix += New-MatrixEntry -DotnetVersion $dotnetVersions[0] -Platform "linux" -RunnerOs "ubuntu-latest"
        }
        elseif ($testSubset -eq "base-only") {
          foreach ($dotnetVersion in $dotnetVersions) {
            $matrix += New-MatrixEntry -DotnetVersion $dotnetVersion -Platform "linux" -RunnerOs "ubuntu-latest"
            $matrix += New-MatrixEntry -DotnetVersion $dotnetVersion -Platform "windows" -RunnerOs "windows-latest"
          }
        }
        else {
          foreach ($dotnetVersion in $dotnetVersions) {
            $matrix += New-MatrixEntry -DotnetVersion $dotnetVersion -Platform "linux" -RunnerOs "ubuntu-latest" -BuildTest 'true' -AndroidApiLevel '35'
            $matrix += New-MatrixEntry -DotnetVersion $dotnetVersion -Platform "windows" -RunnerOs "windows-latest"
          }
        }
        
        # Convert to GitHub Actions matrix format
        $matrixJson = @{ include = $matrix } | ConvertTo-Json -Compress -Depth 3
        Write-Host "Matrix: $matrixJson"
        echo "matrix=$matrixJson" >> $env:GITHUB_OUTPUT

  # Step 2: Build Images (no push)
  build-images:
    name: ğŸ”¨ Build Images (${{ matrix.platform }}, .NET ${{ matrix.dotnet_version }})
    runs-on: ${{ matrix.runner_os }}
    needs: validate-workloads
    if: needs.validate-workloads.result == 'success'
    strategy:
      matrix: ${{ fromJson(needs.validate-workloads.outputs.matrix) }}
      fail-fast: false
      max-parallel: 4  # Limit parallel builds to avoid resource issues
    
    steps:
    - name: ğŸ›’ Checkout
      uses: actions/checkout@v4

    - name: ğŸ’¾ Setup Docker Buildx
      if: matrix.platform == 'linux'
      uses: docker/setup-buildx-action@v3
      with:
        driver: docker

    - name: ğŸ”¨ Build Docker image
      shell: pwsh
      run: |
        Write-Host "Building Docker image for .NET ${{ matrix.dotnet_version }} on ${{ matrix.platform }}"
        $dockerPlatform = "${{ matrix.platform }}/amd64"
        $buildArgs = @{
          DotnetVersion    = "${{ matrix.dotnet_version }}"
          DockerRepository = "${{ env.DOCKER_REPOSITORY_BASE }}"
          DockerPlatform   = $dockerPlatform
          Version          = "pr-test"
          Push             = $false
          Load             = $true
        }
        ./docker/build.ps1 @buildArgs

    - name: ğŸ” Validate Docker image
      shell: pwsh
      run: |
        $imageName = "${{ env.DOCKER_REPOSITORY_BASE }}:dotnet${{ matrix.dotnet_version }}-pr-test"
        Write-Host "Validating image: $imageName"
        $imageExists = docker images --format "{{.Repository}}:{{.Tag}}" | Select-String -Pattern "$imageName"
        if ($imageExists) {
          Write-Host "âœ… Docker image built successfully: $imageName"
          $imageInfo = docker images --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}\t{{.CreatedAt}}" --filter "reference=$imageName"
          Write-Host $imageInfo
        } else {
          Write-Error "âŒ Base image not found: $imageName"
          docker images
          exit 1
        }

    - name: ğŸ§ª Basic image test
      shell: pwsh
      run: |
        # Construct image name
        $imageName = "${{ env.DOCKER_REPOSITORY_BASE }}:dotnet${{ matrix.dotnet_version }}-pr-test"

        Write-Host "Testing basic functionality of: $imageName"
        
        if ("${{ matrix.platform }}" -eq "linux") {
          # Test dotnet command
          $dotnetVersion = docker run --rm $imageName dotnet --version
          Write-Host "âœ… .NET Version: $dotnetVersion"
          
          # Test MAUI workload is installed
          $workloads = docker run --rm $imageName dotnet workload list
          if ($workloads -match "maui") {
            Write-Host "âœ… MAUI workload is installed"
          } else {
            Write-Warning "âš ï¸ MAUI workload may not be installed"
          }
          
          # Test PowerShell
          $pwshVersion = docker run --rm $imageName pwsh -c '$PSVersionTable.PSVersion'
          Write-Host "âœ… PowerShell Version: $pwshVersion"
          
          # Test Android SDK tools are available
          $androidHome = docker run --rm $imageName bash -c 'echo $ANDROID_HOME'
          Write-Host "âœ… Android Home: $androidHome"
          
          # Test key Android tools
          $androidSdkTools = docker run --rm $imageName bash -c 'ls $ANDROID_HOME/cmdline-tools/*/bin/sdkmanager 2>/dev/null | head -1'
          if ($androidSdkTools) {
            Write-Host "âœ… Android SDK Manager found"
          } else {
            Write-Warning "âš ï¸ Android SDK Manager not found"
          }
          
          # Test Java installation
          $javaVersion = docker run --rm $imageName bash -c 'java -version 2>&1 | head -1'
          Write-Host "âœ… Java Version: $javaVersion"
        }
        elseif ("${{ matrix.platform }}" -eq "windows") {
          # Test dotnet command (Windows)
          $dotnetVersion = docker run --rm $imageName powershell -c "dotnet --version"
          Write-Host "âœ… .NET Version: $dotnetVersion"
          
          # Test MAUI workload is installed (Windows)
          $workloads = docker run --rm $imageName powershell -c "dotnet workload list"
          if ($workloads -match "maui") {
            Write-Host "âœ… MAUI workload is installed"
          } else {
            Write-Warning "âš ï¸ MAUI workload may not be installed"
          }
          
          # Test Android SDK tools are available (Windows)
          $androidHome = docker run --rm $imageName powershell -c 'echo $env:ANDROID_HOME'
          Write-Host "âœ… Android Home: $androidHome"
          
          # Test Java installation (Windows)
          $javaCheck = docker run --rm $imageName powershell -c 'if (Get-Command java -ErrorAction SilentlyContinue) { "Java is available" } else { "Java not found" }'
          if ($javaCheck -match "available") {
            Write-Host "âœ… Java is installed and available"
            # Get version info - java -version outputs to stderr and returns exit code 1, which is normal
            $javaVersionOutput = docker run --rm $imageName powershell -c 'java -version 2>&1; if ($LASTEXITCODE -eq 1 -or $LASTEXITCODE -eq 0) { exit 0 }'
            if ($javaVersionOutput) {
              $versionLine = $javaVersionOutput | Select-String "openjdk|java" | Select-Object -First 1
              if ($versionLine) {
                Write-Host "Java Version Info: $versionLine"
              }
            }
          } else {
            Write-Error "âŒ Java installation test failed: $javaCheck"
            exit 1
          }
        }

    - name: ğŸ§ª Test runner functionality
      shell: pwsh
      run: |
        # Construct image name
        $imageName = "${{ env.DOCKER_REPOSITORY_BASE }}:dotnet${{ matrix.dotnet_version }}-pr-test"

        Write-Host "Testing runner functionality: $imageName"

        if ("${{ matrix.platform }}" -eq "linux") {
          # Test that GitHub Actions runner files are present
          $githubRunnerScript = docker run --rm $imageName bash -c 'ls /home/mauiusr/actions-runner/run.sh 2>/dev/null && echo "found" || echo "not found"'
          if ($githubRunnerScript -eq "found") {
            Write-Host "âœ… GitHub Actions runner found"
          } else {
            Write-Error "âŒ GitHub Actions runner script not found"
            exit 1
          }

          # Test that Gitea runner files are present
          $giteaRunnerBinary = docker run --rm $imageName bash -c 'ls /home/mauiusr/gitea-runner/act_runner 2>/dev/null && echo "found" || echo "not found"'
          if ($giteaRunnerBinary -eq "found") {
            Write-Host "âœ… Gitea Actions runner found"
          } else {
            Write-Error "âŒ Gitea Actions runner binary not found"
            exit 1
          }
        }
        elseif ("${{ matrix.platform }}" -eq "windows") {
          # Test that GitHub Actions runner files are present (Windows)
          $githubRunnerScript = docker run --rm $imageName powershell -c "if (Test-Path 'C:\actions-runner\run.cmd') { Write-Output 'found' } else { Write-Output 'not found' }"
          if ($githubRunnerScript -match "found") {
            Write-Host "âœ… GitHub Actions runner found"
          } else {
            Write-Error "âŒ GitHub Actions runner script not found"
            exit 1
          }

          # Test that Gitea runner files are present (Windows)
          $giteaRunnerBinary = docker run --rm $imageName powershell -c "if (Test-Path 'C:\gitea-runner\act_runner.exe') { Write-Output 'found' } else { Write-Output 'not found' }"
          if ($giteaRunnerBinary -match "found") {
            Write-Host "âœ… Gitea Actions runner found"
          } else {
            Write-Error "âŒ Gitea Actions runner binary not found"
            exit 1
          }
        }

    - name: ğŸ”¨ Build test image
      if: matrix.build_test == 'true'
      shell: pwsh
      run: |
        Write-Host "Building test image for .NET ${{ matrix.dotnet_version }} on ${{ matrix.platform }}"
        $dockerPlatform = "${{ matrix.platform }}/amd64"
        $buildArgs = @{
          DotnetVersion        = "${{ matrix.dotnet_version }}"
          DockerRepository     = "${{ env.DOCKER_REPOSITORY_TEST }}"
          DockerPlatform       = $dockerPlatform
          AndroidSdkApiLevel   = "${{ matrix.android_api_level }}"
          Version              = "pr-test"
          Push                 = $false
          Load                 = $true
        }
        if ("${{ matrix.platform }}" -eq "linux") {
          $buildArgs.UseBuildx = $false
        }
        ./docker/test/build.ps1 @buildArgs

    - name: ğŸ” Validate test image
      if: matrix.build_test == 'true'
      shell: pwsh
      run: |
        $imageName = "${{ env.DOCKER_REPOSITORY_TEST }}:android${{ matrix.android_api_level }}-dotnet${{ matrix.dotnet_version }}-pr-test"
        Write-Host "Validating image: $imageName"
        $imageExists = docker images --format "{{.Repository}}:{{.Tag}}" | Select-String -Pattern "$imageName"
        if ($imageExists) {
          Write-Host "âœ… Test image built successfully: $imageName"
        } else {
          Write-Error "âŒ Test image not found: $imageName"
          docker images
          exit 1
        }

    - name: ğŸ§ª Test image test
      if: matrix.build_test == 'true'
      shell: pwsh
      run: |
        # Construct image name
        $imageName = "${{ env.DOCKER_REPOSITORY_TEST }}:android${{ matrix.android_api_level }}-dotnet${{ matrix.dotnet_version }}-pr-test"

        Write-Host "Testing Appium/Emulator functionality of: $imageName"
        
        # Test that Appium is installed
        $appiumVersion = docker run --rm $imageName bash -c 'appium --version 2>/dev/null || echo "not found"'
        if ($appiumVersion -ne "not found") {
          Write-Host "âœ… Appium Version: $appiumVersion"
        } else {
          Write-Warning "âš ï¸ Appium not found"
        }
        
        # Test that Android Emulator is available
        $emulatorPath = docker run --rm $imageName bash -c 'which emulator 2>/dev/null || echo "not found"'
        if ($emulatorPath -ne "not found") {
          Write-Host "âœ… Android Emulator found at: $emulatorPath"
        } else {
          Write-Warning "âš ï¸ Android Emulator not found"
        }
        
        # Test that the correct Android API level system image is installed
        $systemImages = docker run --rm $imageName bash -c 'ls $ANDROID_HOME/system-images/android-${{ matrix.android_api_level }}/ 2>/dev/null | head -5 || echo "not found"'
        if ($systemImages -ne "not found") {
          Write-Host "âœ… Android ${{ matrix.android_api_level }} system images found"
        } else {
          Write-Warning "âš ï¸ Android ${{ matrix.android_api_level }} system images not found"
        }

  # Step 3: Summary and cleanup
  pr-validation-summary:
    name: ğŸ“‹ PR Validation Summary
    runs-on: ubuntu-latest
    needs: [validate-workloads, build-images]
    if: always()
    
    steps:
    - name: ğŸ“‹ Generate PR Summary
      run: |
        echo "## ğŸ” PR Validation Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Workload validation results
        echo "### Workload Discovery" >> $GITHUB_STEP_SUMMARY
        if [ "${{ needs.validate-workloads.result }}" == "success" ]; then
          echo "âœ… **Workload discovery passed** - All .NET versions successfully resolved workload sets" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Workload discovery failed** - Check workload discovery step for details" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Build results
        echo "### Docker Image Builds" >> $GITHUB_STEP_SUMMARY
        if [ "${{ needs.build-images.result }}" == "success" ]; then
          echo "âœ… **All image builds successful** - Images built and validated locally" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ needs.build-images.result }}" == "failure" ]; then
          echo "âŒ **Some image builds failed** - Check individual build jobs for details" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ needs.build-images.result }}" == "cancelled" ]; then
          echo "âš ï¸ **Image builds cancelled** - Builds were cancelled (possibly due to workload validation failure)" >> $GITHUB_STEP_SUMMARY
        else
          echo "â­ï¸ **Image builds skipped** - Builds were skipped due to earlier failures" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Overall status
        echo "### Overall Status" >> $GITHUB_STEP_SUMMARY
        if [ "${{ needs.validate-workloads.result }}" == "success" ] && [ "${{ needs.build-images.result }}" == "success" ]; then
          echo "ğŸ‰ **PR validation passed!** This PR is ready for review." >> $GITHUB_STEP_SUMMARY
        else
          echo "ğŸš« **PR validation failed** - Please fix the issues before merging." >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Note:** No images were pushed to registries during this validation." >> $GITHUB_STEP_SUMMARY

    - name: ğŸ” Set Job Status  
      run: |
        if [ "${{ needs.validate-workloads.result }}" != "success" ] || [ "${{ needs.build-images.result }}" != "success" ]; then
          echo "PR validation failed"
          exit 1
        else
          echo "PR validation passed"
        fi
